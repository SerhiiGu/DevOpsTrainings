pipeline {
    agent any

    parameters {
	 choice(
            name: 'ENVIRONMENT',
            choices: ['stage', 'prod'],
            description: 'Choose deploy environment'
        )
        choice(
            name: 'STACK',
            choices: ['traefik', 'elk', 'kafka', 'monitoring'],
            description: 'Choose deploy stack'
        )
    }

    stages {
        stage('Prepare-tests') {
            sh """
                whoami && pwd && ls -la
            """
        }

        stage('Check Inventory') {
            steps {
                sh 'ansible-inventory -i inventory/${params.ENVIRONMENT}.yml --list --yaml'
            }
        }

        stages {
            stage('Deploy Stack ot Environment') {
                steps {
                    script {
                        def inventoryFile = "inventory/${params.ENVIRONMENT}.yml"

                        sh """
                        ansible-playbook -i ${inventoryFile} 10_deploy_${params.STACK}.yml
                        """
                    }
                }
            }
        }

    }

    post {
        success {
            echo 'Deployment successful!'
        }
        failure {
            echo 'Deployment failed!'
        }
    }
}

