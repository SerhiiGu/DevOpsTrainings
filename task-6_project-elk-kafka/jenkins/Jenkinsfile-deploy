pipeline {
    agent any

    parameters {
	 choice(
            name: 'ENVIRONMENT',
            choices: ['prod', 'stage'],
            description: 'Choose deploy environment'
        )
        choice(
            name: 'STACK',
            choices: ['elk', 'traefik', 'kafka', 'monitoring'],
            description: 'Choose deploy stack'
        )
    }

    stages {
        stage('Prepare-tests') {
            steps {
                dir('task-6_project-elk-kafka/ansible') {
                    sh """
                        whoami && pwd && ls -la
                    """
                }
            }
        }

        stage('Check Inventory') {
            steps {
                dir('task-6_project-elk-kafka/ansible') {
                    sh "/usr/bin/ansible-inventory -i inventory/${params.ENVIRONMENT}.yml --list --yaml"
                }
            }
        }

        stage('Deploy Stack ot Environment') {
            steps {
                dir('task-6_project-elk-kafka/ansible') {
                    script {
                        def inventoryFile = "inventory/${params.ENVIRONMENT}.yml"

                        sh """
                            /usr/bin/ansible-playbook -i ${inventoryFile} 10_deploy_${params.STACK}.yml
                        """
                    }
                }
            }
        }

    }

    post {
        success {
            echo 'Deployment successful!'
        }
        failure {
            echo 'Deployment failed!'
        }
    }
}

