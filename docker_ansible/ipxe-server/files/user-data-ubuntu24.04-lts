#cloud-config
autoinstall:
  version: 1
  # disable updates to prevent error and for faster installation
  apt:
    update: false
    upgrade: false
  identity:
    hostname: ubuntu-server
    password: "$6$Rapdb1xkkqqPtYHR$5dVZBx8BYRPkVhLopees3rz9vep.nvehdjKArHgOkg3nv3AID8PSsBzEuTcQNll9ySkEAljU2DtY0a0uUfIhu." # hashed: openssl passwd -6
    username: ubuntu
  keyboard: {layout: us, variant: ''}
  locale: en_US.UTF-8

  network:
    version: 2
    ethernets:
      enp0s3:
        addresses:
          - 192.168.1.190/24
        nameservers:
          addresses: [8.8.8.8, 1.1.1.1]
        routes:
          - to: default
            via: 192.168.1.1
  storage:
    config:
      - type: disk
        id: disk-0
        match:
          smallest: true
        wipe: superblock 
        preserve: false
        grub_device: true
        ptable: gpt

      # 1. Технічний розділ для GRUB (необхідний для GPT на BIOS/Legacy системі)
      - type: partition
        id: partition-grub
        device: disk-0
        size: 2M
        flag: bios_grub

      # 2. Swap 128MB
      - type: partition
        id: partition-swap
        device: disk-0
        size: 128M
      - type: format
        id: format-swap
        fstype: swap
        volume: partition-swap
      - type: mount
        id: mount-swap
        device: format-swap
        path: none

      # 3. Основний розділ (корінь)
      - type: partition
        id: partition-root
        device: disk-0
        size: -1
        flag: boot
      - type: format
        id: format-root
        fstype: ext4
        volume: partition-root
      - type: mount
        id: mount-root
        device: format-root
        path: /

    grub:
      device: disk-0
      terminal: console

  ssh:
    install-server: true
    allow-pw: true

  user-data:
    users:
      - name: root
        lock_passwd: false
        ssh_authorized_keys:
          - ssh-rsa AAAAB3NzaC1yc2EAAAABIwAAAQEA2AgW9ikJ2axkwkh+XLJQjHY4SDt65wlQVnINSkNKYVj4jU5KskwxrybEmwwD1YvMJL5k5q8QWUgyOzzE/smAMDgka1wNJgMIfeiP9At5lP6Ars2LQ2xlq4Qeu9891RsWEwyMM71BNeHvzE6f8Mc9JC3HbWGXoPJP9jQEpt5dI5Toi8/9uPG+KTxkOOaOPynMvfG8sC8LE5RnOXpFFBlBrHRCsnRKkFF6/rIOGPzDQs24Ox4USBma+QyDcLbWhMU2L5pDjBJeLvX7ONPq0VDy9lujATRSfhKiGsKjv/XPhrxXuIAixiYMaK89feC5I6i3c97dBLC84PU16GrNmkkZIw==

  packages:
    - net-tools
    - curl
    - wget
    - vim

  late-commands:
    - |
      cat <<EOF > /target/etc/ssh/sshd_config.d/99-custom.conf
      PubkeyAuthentication yes
      PasswordAuthentication yes
      PermitRootLogin yes
      EOF
    - curtin in-target -- bash -c "echo 'root:\$6\$Rapdb1xkkqqPtYHR\$5dVZBx8BYRPkVhLopees3rz9vep.nvehdjKArHgOkg3nv3AID8PSsBzEuTcQNll9ySkEAljU2DtY0a0uUfIhu.' | chpasswd -e"
    - curtin in-target -- passwd -u root
    - curtin in-target -- /usr/bin/apt-get clean
    - curtin in-target -- /bin/sh -c "rm -rf /var/lib/apt/lists/*"
    - curtin in-target -- /usr/bin/find /tmp /var/tmp -mindepth 1 -delete
    - curtin in-target -- sed -i 's/^root:!/root:/' /etc/shadow
    - curtin in-target -- sed -i 's/ExecStart=.*/ExecStart=-\/sbin\/reboot -f/' /lib/systemd/system/final.target.wants/debian-installer-reboot.service || true

