---
- name: Install QEMU 10.2 from Source
  hosts: all
  become: true
  vars:
    qemu_version: "10.2.0"
    build_dir: "/root/qemu-build-disk"
    qemu_bridge_helper_path: "/usr/local/libexec/qemu-bridge-helper"
    manager_path: "/usr/local/bin/qemu-manager.py"

  tasks:
    - name: Update apt cache
      ansible.builtin.apt:
        update_cache: true
        cache_valid_time: 7200

    - name: Install build dependencies
      apt:
        name:
          - build-essential
          - git
          - libglib2.0-dev
          - libfdt-dev
          - libpixman-1-dev
          - zlib1g-dev
          - ninja-build
          - python3-full
          - python3-jsonschema
          - python3-pip
          - python3-venv
          - pkg-config
          - rustc
          - rust-all
          - cargo
          - liburing-dev
          - libcap-ng-dev
          - libaio-dev
          - libattr1-dev
          - libvdeplug-dev
          - libspice-server-dev
          - libspice-protocol-dev
        state: present

    - name: Install Sphinx dependencies
      apt:
        name:
          - python3-sphinx
          - python3-sphinx-rtd-theme
          - python3-stemmer
          - python3-babel
          - python3-alabaster
          - python3-imagesize
          - sphinx-common
        state: present

    - name: Install Rust bindgen and LLVM
      apt:
        name:
          - bindgen
          - clang
          - llvm-dev
        state: present

    - name: Create build directory
      file:
        path: "{{ build_dir }}"
        state: directory

    - name: Check if QEMU source is already extracted
      stat:
        path: "{{ build_dir }}/configure"
      register: source_extracted

    - name: Download QEMU 10.2 source
      get_url:
        url: "https://download.qemu.org/qemu-{{ qemu_version }}.tar.xz"
        dest: "{{ build_dir }}/qemu.tar.xz"
      when: not source_extracted.stat.exists

    - name: Extract QEMU source
      unarchive:
        src: "{{ build_dir }}/qemu.tar.xz"
        dest: "{{ build_dir }}"
        remote_src: yes
        extra_opts: [--strip-components=1]
      when: not source_extracted.stat.exists

    - name: Check if QEMU is already installed
      stat:
        path: /usr/local/bin/qemu-system-x86_64
      register: qemu_binary

    - name: Configure and Build QEMU
      shell: |
        rm -rf build
        ./configure \
          --enable-kvm \
          --enable-linux-aio \
          --enable-linux-io-uring \
          --enable-virtfs \
          --enable-spice \
          --enable-rust \
          --target-list=x86_64-softmmu \
          --prefix=/usr/local \
          --python=/usr/bin/python3
        make -j$(nproc)
        make install
      args:
        chdir: "{{ build_dir }}"
      register: build_output
      when: not qemu_binary.stat.exists

    - name: Verify QEMU version
      command: qemu-system-x86_64 --version
      register: qemu_ver_check

    - name: Display version
      debug:
        msg: "{{ qemu_ver_check.stdout }}"



    - name: Detect real physical interface
      ansible.builtin.shell: |
        if [ -d /sys/class/net/br0/brif ]; then
          # Якщо міст є, беремо назву першого порту в ньому
          ls /sys/class/net/br0/brif | head -n 1
        else
          # Якщо мосту немає, беремо дефолтний інтерфейс
          echo "{{ ansible_facts['default_ipv4']['interface'] }}"
        fi
      register: phy_device_cmd
      changed_when: false

    - name: Set facts for networking
      ansible.builtin.set_fact:
        target_interface: "{{ phy_device_cmd.stdout | trim }}"
        target_ip_cidr: "{{ ansible_facts['default_ipv4']['address'] }}/{{ ansible_facts['default_ipv4']['prefix'] }}"
        target_gateway: "{{ ansible_facts['default_ipv4']['gateway'] }}"

    - name: Debug detected interface
      ansible.builtin.debug:
        msg: "Physical interface is {{ target_interface }}. Bridge will use this port."

    - name: Install bridge-utils
      ansible.builtin.apt:
        name: bridge-utils
        state: present

    - name: Configure Network Bridge (interfaces)
      ansible.builtin.copy:
        dest: /etc/network/interfaces
        content: |
          source /etc/network/interfaces.d/*

          auto lo
          iface lo inet loopback

          # Physical Interface
          auto {{ target_interface }}
          iface {{ target_interface }} inet manual

          # Bridge Interface
          auto br0
          iface br0 inet static
                  address {{ target_ip_cidr }}
                  gateway {{ target_gateway }}
                  bridge_ports {{ target_interface }}
                  bridge_stp off
                  bridge_fd 0
                  dns-nameservers 1.1.1.1
      register: network_config

    - name: Create QEMU configuration directory
      file:
        path: "{{ item.path }}"
        state: directory
        owner: "{{ item.owner | default('root') }}"
        group: "{{ item.group | default('root') }}"
      with_items:
        - { path: '/usr/local/etc' }
        - { path: '/usr/local/etc/qemu' }

    - name: Allow br0 in QEMU bridge.conf
      ansible.builtin.copy:
        dest: /usr/local/etc/qemu/bridge.conf
        content: "allow br0\n"
        mode: '0644'

    - name: Set SUID bit on qemu-bridge-helper
      ansible.builtin.file:
        path: "{{ qemu_bridge_helper_path }}"
        mode: '4755'
        owner: root
        group: root

    - name: Create Systemd Autostart Service
      ansible.builtin.copy:
        dest: /etc/systemd/system/qemu-autostart.service
        content: |
          [Unit]
          Description=QEMU VMs Autostart
          After=network-online.target
          Wants=network-online.target

          [Service]
          Type=oneshot
          ExecStart={{ manager_path }} autostart_all
          RemainAfterExit=yes

          [Install]
          WantedBy=multi-user.target

    - name: Enable Autostart Service
      ansible.builtin.systemd:
        name: qemu-autostart.service
        enabled: yes
        daemon_reload: yes

    - name: Restart networking (Non-blocking)
      ansible.builtin.shell: "nohup sh -c 'ifdown {{ target_interface }} && ifup br0' > /dev/null 2>&1 &"
      async: 10
      poll: 0
      when: network_config.changed

    - name: Wait for connection to return
      ansible.builtin.wait_for_connection:
        delay: 5
        timeout: 60
      when: network_config.changed

